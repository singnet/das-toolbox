import click
from sys import exit
from services import RedisContainerService, MongoContainerService
from services import OpenFaaSContainerService
from exceptions import DockerDaemonException, DockerException
from time import sleep


@click.group()
@click.pass_context
def logs(ctx):
    """
    Manage container logs.

    The \\fBdas-cli logs\\fR command allows you to display logs of various services.
    This command retrieves logs generated by specific services and provides insights into their operations, including information about connections, queries, executions, and errors.
    """

    global config

    config = ctx.obj["config"]


@logs.command()
def das():
    """
    Display logs for das.

    The \\fBdas-cli logs das\\fR command displays the logs of the DAS service.
    This command retrieves the logs generated by the DAS service, which are typically located in
    the /tmp/das.log file.

    .SH EXAMPLES

    Display logs of the DAS service.

    \\fB$ das-cli logs das\\fR
    """
    try:
        with open("/tmp/das.log", "r") as file:
            while True:
                line = file.readline()
                if not line:
                    sleep(0.1)
                    continue
                click.echo(line, nl=False)
    except KeyboardInterrupt:
        click.secho("Interrupted. Exiting...", fg="red")
    except FileNotFoundError:
        click.secho("No logs to show up here", fg="yellow")


@logs.command()
def faas():
    """
    Display logs for OpenFaaS services.

    The \\fBdas-cli logs faas\\fR command displays the logs of the OpenFaaS service.
    This command retrieves the logs generated by the OpenFaaS service, which may include information about function executions, deployments, and errors.

    .SH EXAMPLES

    Display logs of the OpenFaaS service.

    \\fB$ das-cli logs faas\\fR
    """

    openfaas_container_name = config.get("openfaas.container_name")
    mongodb_container_name = config.get("mongodb.container_name")
    redis_container_name = config.get("redis.container_name")

    try:
        openfaas_service = OpenFaaSContainerService(
            openfaas_container_name,
            redis_container_name,
            mongodb_container_name,
        )

        openfaas_service.logs()
    except DockerException as e:
        click.secho(str(e), fg="red")
        click.secho("You need to run the server with command 'db start'", fg="red")
        exit(1)
    except DockerDaemonException as e:
        click.secho(f"{str(e)}\n", fg="red")
        exit(1)


@logs.command()
def mongodb():
    """
    Display logs of the MongoDB service.

    The \\fBdas-cli logs mongodb\\fR command displays the logs of the MongoDB service.
    This command retrieves the logs generated by the MongoDB service, which may include information about database connections, queries, and errors.

    .SH EXAMPLES

    Display logs of the MongoDB service.

    \\fB$ das-cli logs mongodb\\fR
    """

    mongodb_container_name = config.get("mongodb.container_name")

    try:
        mongodb_service = MongoContainerService(mongodb_container_name)

        mongodb_service.logs()
    except DockerException as e:
        click.secho(str(e), fg="red")
        click.secho("You need to run the server with command 'db start'", fg="red")
        exit(1)
    except DockerDaemonException as e:
        click.secho(f"{str(e)}\n", fg="red")
        exit(1)


@logs.command()
def redis():
    """
    Display logs for Redis.

    The \\fBdas-cli logs redis\\fR command displays the logs of the Redis service.
    This command retrieves the logs generated by the Redis service, which may include information about connections, commands, and errors.

    EXAMPLES

    Display logs of the Redis service.

    \\fB$ das-cli logs redis\\fR
    """
    redis_container_name = config.get("redis.container_name")

    try:
        redis_service = RedisContainerService(redis_container_name)

        redis_service.logs()
    except DockerException as e:
        click.secho(str(e), fg="red")
        click.secho("You need to run the server with command 'db start'", fg="red")
        exit(1)
    except DockerDaemonException as e:
        click.secho(f"{str(e)}\n", fg="red")
        exit(1)
